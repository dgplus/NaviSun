<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Map: Community Solar Capacity by State | DG+</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,300" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/map-styles.css">
</head>

<body>
    <div id="mapcontainer">
        <div id="map" style="width: 100%; height: 500px;"></div>
        <div class="map-overlay top">
            <div class="map-overlay-inner">
                <h3>NaviSun Project Capacity</h3>
                <h4>Kilowatts (kW)</h4>
                <div class="legend-container">
                    <div id="legend" class="column"></div>
                </div>
            </div>
        </div>
        <div id="fullscreen">Full screen</div>
    </div>

    <script>
        const legendDiv = document.getElementById('legend');
        const layerName = 'states-layer';
        const fullscreen = document.getElementById('fullscreen');
        const mainData = {
            sprData: []
        };

        mapboxgl.accessToken = 'pk.eyJ1IjoiZGdwbHVzZGVzaWduIiwiYSI6ImNsZTF2bGtuczFwYXYzcnBrYm5xM2VwZHUifQ.bsWl7gNOVYm4-_62gDEjqA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: {
                lng: -86.065541,
                lat: 38.92230044374887
            },
            zoom: 3.8,
            projection: "mercator"
        });

        map.on('load', () => {
            Promise.all([
                d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vRWkjhMGbmqFTQiTkS9fYH0T9jydBhPGKkBWE-XVrgbNwHn0tgWc9E42NsPFYqaRQ/pub?gid=309868205&single=true&output=csv"),
                fetch("base/s_22mr22.json").then(data => data.json())
            ]).then(data => {
                const [sprData, mapData] = data;
                mainData.sprData.push(...sprData);
                map.addSource('states', {
                    'type': 'geojson',
                    'data': mapData
                });

                // Add a layer for states
                map.addLayer({
                    'id': 'states-layer',
                    'type': 'fill',
                    'source': 'states',
                    'paint': {
                        'fill-outline-color': 'rgba(255, 255, 255, .5)',
                    }
                });

                // Calculate total capacity per state
                const stateTotals = {};
                sprData.forEach(d => {
                    const state = d.State;
                    const capacity = +d['Capacity'];

                    if (!stateTotals[state]) {
                        stateTotals[state] = 0;
                    }
                    stateTotals[state] += capacity;
                });

                // Get min and max of total capacities
                const capacities = Object.values(stateTotals);
                const minCapacity = Math.min(...capacities);
                const maxCapacity = Math.max(...capacities);

                // Create a color scale with 10,000 kW increments based on total state capacity
                const thresholds = d3.range(10000, maxCapacity, 10000);
                const myColor = d3.scaleThreshold()
                    .domain(thresholds)
                    .range(["#dbeefc", "#adcdfc", "#9abffc", "#8ab4fc", "#6fa1fc", "#1b64fe"]);

                generateLegend(minCapacity, maxCapacity, legendDiv, myColor);

                // Assign colors to states based on total capacity
                const filtersArray = [];
                Object.keys(stateTotals).forEach(state => {
                    const totalCapacity = stateTotals[state];
                    filtersArray.push(['==', ['get', "STATE"], state], myColor(totalCapacity));
                });

                map.setPaintProperty(layerName, "fill-color", ['case', ...filtersArray, "transparent"]);
                map.setPaintProperty(layerName, "fill-opacity", 0.9);
            });
        });

        // Generate the legend with 10,000 kW bins based on total state capacity
        function generateLegend(min, max, legendDiv, myColor) {
            const step = 10000; // Fixed 10,000 kW increments
            const bins = myColor.domain(); // Use the thresholds from the color scale for the legend

            bins.forEach((threshold, i) => {
                const startVal = i === 0 ? 0 : bins[i - 1];
                const endVal = threshold;

                const text = document.createElement("div");
                text.className = "square-text";
                text.innerText = `${startVal.toLocaleString()} - ${endVal.toLocaleString()} kW`;

                const sq = document.createElement("div");
                sq.className = "square";
                sq.style.backgroundColor = myColor(endVal);
                sq.style.opacity = 0.9;

                const div = document.createElement("div");
                div.className = "square-container";
                div.appendChild(sq);
                div.appendChild(text);

                legendDiv.appendChild(div);
            });

            const finalThreshold = bins[bins.length - 1];
            const finalText = document.createElement("div");
            finalText.className = "square-text";
            finalText.innerText = `${finalThreshold.toLocaleString()}+ kW`;

            const finalSq = document.createElement("div");
            finalSq.className = "square";
            finalSq.style.backgroundColor = myColor(max);
            finalSq.style.opacity = 0.9;

            const finalDiv = document.createElement("div");
            finalDiv.className = "square-container";
            finalDiv.appendChild(finalSq);
            finalDiv.appendChild(finalText);

            legendDiv.appendChild(finalDiv);
        }
    </script>

</body>

</html>
